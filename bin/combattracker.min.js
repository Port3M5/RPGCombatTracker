(function(){"use strict";var a,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a},d=function(a,b){return function(){return a.apply(b,arguments)}};a=typeof exports!="undefined"&&exports!==null?exports:this,a.Creature=function(){function a(a){return this.name=a,console.log("Creating Creature called "+this.name),this}return a.prototype.name=null,a.prototype.initiative=null,a.prototype.delayed=!1,a.prototype.events=[],a.prototype.add_event=function(a){return console.log("Adding event "+a.name+" to "+this.name),this.events.push(a),this},a.prototype.is_delayed=function(){return this.delayed},a.prototype.set_initiative=function(a){return this.initiative=a,console.log("Setting "+this.name+"'s initiative to "+this.initiative),this},a.prototype.roll_initiative=function(a){var b;return console.log("Rolling the initiative of "+this.name+" with a modifier of "+a),b=new Dice("d20+"+a,0),this.initiative=b.result,this},a.prototype.tick=function(){var a,b,c,d;d=this.events;for(b=0,c=d.length;b<c;b++)a=d[b],a instanceof Event&&(a.tick(),a.time===0&&this.events.splice(b,1));return this},a.prototype.toString=function(){var a;return'<div class="creature" data-name="'+this.name+'" data-initiative="'+this.initiative+'">\n  <header>\n    <hgroup>\n      <h1>'+this.name+"</h1>\n      <h2>Initiative "+this.initiative+"</h2>\n    </hgroup>\n  </header>\n  "+function(){var b,c,d,e;d=this.events,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a);return e}.call(this)+"\n  <footer>\n    "+(this.delayed?"<a class='undelay' href='#' data-name='"+this.name+"'>Undelay</a>":"")+'\n    <a href="#" class="kill">Kill</a>\n  </footer>\n</div>'},a}(),a.PC=function(){function b(a,c){return this.name=a,this.initiative=c,b.__super__.constructor.call(this,this.name),this}return c(b,a.Creature),b}(),a.NPC=function(){function b(a,c,d){this.name=a,this.hp=d!=null?d:0,this.roll_initiative(c),b.__super__.constructor.call(this,this.name)}return c(b,a.Creature),b.prototype.hp=0,b.prototype.set_hp=function(a){return console.log("Setting HP of "+this.name+" to "+a),this.hp=+a,this},b.prototype.harm=function(a){return console.log("Harming "+this.name+" by "+a),this.hp-=+a,this},b.prototype.heal=function(a){return console.log("Healing "+this.name+" by "+a),this.hp+=+a,this},b.prototype.toString=function(){return'<div class="creature" data-name="'+this.name+'" data-initiative="'+this.initiative+'" data-hp="'+this.hp+'">\n  <header>\n    <hgroup>\n      <h1>'+this.name+"</h1>\n      <h2>Initiative "+this.initiative+"</h2>\n      <h3>"+this.hp+" HP</h3>\n    </hgroup>\n  </header>\n  "+this.events.join(" ")+"\n  <footer>\n    "+(this.delayed?"<a class='undelay' href='#' data-name='"+this.name+"'>Undelay</a>":"")+'\n    <a href="#" class="harm" data-name="'+this.name+'" data-amount="1">Harm 1</a>\n    <a href="#" class="harm" data-name="'+this.name+'" data-amount="5">Harm 5</a>\n    <a href="#" class="harm" data-name="'+this.name+'" data-amount="10">Harm 10</a>\n    <a href="#" class="kill" data-name="'+this.name+'">Kill</a>\n  </footer>\n</div>'},b}(),a=typeof exports!="undefined"&&exports!==null?exports:this,a.Dice=function(){function a(a,b){var c,d,e,f,g,h,i;this.roll=a,this.droplowest=b,e=/^(\d+)?d(\d+)([+\-]\d+)?$/,c=this.roll.match(e);if(c!=null){this.amount=+c[1],this.size=+c[2],this.modifier=+c[3],this.droplowest=+this.droplowest,isNaN(this.amount)&&(this.amount=1),isNaN(this.modifier)&&(this.modifier=0),isNaN(this.droplowest)&&(this.droplowest=0),this.results=function(){var a,b;b=[];for(f=1,a=this.amount;1<=a?f<=a:f>=a;1<=a?f++:f--)b.push(Math.floor(Math.random()*this.size+1));return b}.call(this),this.droplowest!==0?(this.dropped=this.results.sort().reverse().slice(-this.droplowest),this.dropped.sort()):this.dropped=[],this.results=this.results.sort().slice(this.droplowest),this.result=0,i=this.results;for(g=0,h=i.length;g<h;g++)d=i[g],this.result+=d;this.result+=this.modifier}}return a.prototype.amount=null,a.prototype.droplowest=null,a.prototype.size=null,a.prototype.modifier=null,a.prototype.results=null,a.prototype.dropped=null,a.prototype.result=null,a.prototype.get_roll=function(){return this.roll},a.prototype.get_result=function(){return this.result},a.prototype.get_results=function(){return this.results},a.prototype.get_dropped=function(){return this.dropped},a.prototype.get_droplowest=function(){return this.droplowest},a.prototype.get_modifier=function(){return this.modifier},a.prototype.toString=function(){return"Rolled "+this.get_roll()+(this.get_droplowest()!==0?" dropped "+this.get_droplowest():void 0)+" and got "+this.get_result()+" in total"},a}(),a=typeof exports!="undefined"&&exports!==null?exports:this,a.Event=function(){function a(a,b){this.name=a,this.time=b,console.log("Creating event "+this.name+" with a duration "+this.time)}return a.prototype.time=0,a.prototype.description=null,a.prototype.tick=function(){return this.time--},a.prototype.set_description=function(a){return this.description=a,console.log("Setting "+this.name+"'s description to "+this.description)},a.prototype.announce=function(){return console.log("Announcing event "+this.name+"'s expiration"),""+this.name+" has expired. "+(this.description!=null?this.description:"")},a.prototype.toString=function(){return'<div class="event" data-name="'+this.name+'" data-time="'+this.time+'">\n  <header>\n    <h1>'+this.name+"</h1>\n    <h2>"+this.time+" rounds remaining</h2>\n  </header>\n  <p>"+(this.description!=null?this.discription:"")+"</p>\n</div>"},a}(),a.Timer=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,a.Event),b.prototype.tick=function(){this.time--;if(this.time===0)return this.announce()},b}(),a.Ticker=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,a.Event),b.prototype.tick=function(){return b.__super__.tick.apply(this,arguments),this.announce()},b.prototype.announce=function(){return console.log("Announcing event "+this.name+"'s tick"),""+this.name+" has ticked. "+(this.description!=null?this.description:"")},b}(),a=typeof exports!="undefined"&&exports!==null?exports:this,a.Tracker=function(){function a(){console.log("Creating tracker object")}return a.prototype.creatures=[],a.prototype.started=!1,a.prototype.round=0,a.prototype.part=0,a.prototype.add_creature=function(a){return console.log("Adding "+a.name+" to tracker"),this.creatures.push(a)},a.prototype.draw=function(){return console.log("Drawing the tracker"),this.toString()},a.prototype.get_current_creature=function(){var a;return console.log("Getting current creature"),a=this.get_creatures()[this.part],a},a.prototype.kill_creature=function(a){var b,c,d,e,f;console.log("Killing "+a.name),e=this.creatures,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b===a?(this.creatures.splice(c,1),this.tick()):void 0);return f},a.prototype.delay_creature=function(a){return console.log("Delaying "+a.name),a.delayed=!0,this.tick()},a.prototype.get_delayed_creatures=function(){var a,b,c,d,e;b=[],e=this.creatures;for(c=0,d=e.length;c<d;c++)a=e[c],a.is_delayed()&&b.push(a);return b},a.prototype.get_creatures=function(){var a,b,c,d,e;b=[],e=this.creatures;for(c=0,d=e.length;c<d;c++)a=e[c],a.is_delayed()||b.push(a);return b},a.prototype.undelay_creature=function(a){var b,c,d,e,f;console.log("Undelaying "+a.name+" and changing initiative"),e=this.creatures,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b===a&&a.is_delayed()?(a.initiative=this.get_creatures()[this.part].initiative-1,a.delayed=!1,this.sort_by_initiative()):void 0);return f},a.prototype.compare_initiatives=function(a,b){return b.initiative-a.initiative},a.prototype.sort_by_initiative=function(){return console.log("Sorting creatures by initiative"),this.creatures.sort(this.compare_initiatives)},a.prototype.find_creature=function(a){var b,c,d,e;console.log("Finding "+a),e=this.creatures;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.name===a&&b instanceof Creature)return b}},a.prototype.start_encounter=function(){if(!this.started)return console.log("Starting the encounter"),this.sort_by_initiative(),this.round=1,this.started=!0,this.tick()},a.prototype.next=function(){return console.log("Going to the next creature"),this.part=(this.part+1)%this.get_creatures().length,this.part===0&&this.round++,this.tick()},a.prototype.tick=function(){var a;return console.log("Round "+this.round+" part "+this.part+". "+this.get_current_creature().name+" to go."),a=this.get_current_creature(),a.tick(),a},a.prototype.toString=function(){var a;return'<div id="tracker" data-round="'+this.round+'">\n  <header>\n    <hgroup>\n      <h1>Round '+this.round+'</h1>\n    </hgroup>\n  </header>\n  <div class="creatures">\n    '+function(){var b,c,d,e;d=this.get_creatures(),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a);return e}.call(this)+'\n  </div>\n  <div class="creatures delayed">\n    '+function(){var b,c,d,e;d=this.get_delayed_creatures(),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a);return e}.call(this)+'\n  </div>\n  <div class="clear"></div>\n</div>'},a}(),$(function(){var a,b,c,e;return e=new Tracker,b=function(){var a;return a=[],a.concat(e.creatures),a.concat(e.delayed),a},c=function(){return $("#tracker").remove(),$("#content").append(e.draw()),$("div.creature").not("div.delayed").eq(e.part).addClass("current_creature")},$("#start").live("click",d(function(a){return a.preventDefault(),$("#start").attr("id","next").text("Next Initiative"),e.start_encounter(),c()},this)),$("#next").live("click",d(function(a){return a.preventDefault(),e.next(),c()},this)),$("form#add_pc").submit(function(b){var c,d,f;return b.preventDefault(),d=$("#pc_name").val(),c=+$("#pc_initiative").val(),f=new PC(d,c),e.add_creature(f),$(this)[0].reset(),a(d)}),$("form#add_npc").submit(function(b){var c,d,f,g,h,i,j,k,l;b.preventDefault(),g=$("#npc_name").val(),f=+$("#npc_modifier").val(),d=+$("#npc_health").val(),c=+$("#npc_amount").val();if(c===NaN||c<=0)c=1;if(c===1)h=new NPC(g,f,d),e.add_creature(h),a(h.name);else{i=function(){var a;a=[];for(j=1;1<=c?j<=c:j>=c;1<=c?j++:j--)a.push(new NPC(""+g+" "+j,f,d));return a}();for(k=0,l=i.length;k<l;k++)h=i[k],console.log(h),e.add_creature(h),a(h.name)}return $(this)[0].reset()}),$("form#add_event").submit(function(a){var b,c,d,f,g;return a.preventDefault(),f=$("#event_name").val(),d=$("#event_duration").val(),g=$("#event_type").val(),c=$("#event_description").val(),b=$("#add_to").val(),a=g==="Ticker"?new Ticker(f,d):new Timer(f,d),a.set_description(c),e.find_creature(b).add_event(a),$(this)[0].reset()}),$("#delay").click(function(a){return a.preventDefault(),e.delay_creature(e.find_creature($(".current_creature").data("name"))),c()}),$(".undelay").live("click",function(a){return a.preventDefault(),console.log($(this)),e.undelay_creature(e.find_creature($(this).data("name"))),c()}),a=function(a){return $("select#add_to").append("<option value='"+a+"'>"+a+"</option>")},$(".harm").live("click",function(a){var b,d;return a.preventDefault(),b=$(this).data("amount"),d=e.find_creature($(this).data("name")),d.harm(b),c()}),$(".kill").live("click",function(a){var b;return a.preventDefault(),b=e.find_creature($(this).data("name")),e.kill_creature(b),c()})})}).call(this)